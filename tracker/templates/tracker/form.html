{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>{{ title }} - Expense Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { max-width: 900px; margin-top: 2rem; }
        .form-actions { margin-top: 1.5rem; }
        .payments-panel { margin-top: 1.5rem; }
        .payments-list .payment-item { border-bottom: 1px solid #eee; padding: .6rem 0; }
        .small-muted { color: #6c757d; font-size: .9rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="card-title mb-0">{{ title }}</h2>
                {% if tender %}
                    <div class="small-muted">Tender: <strong>{{ tender.tender_no }}</strong></div>
                {% endif %}
            </div>
            <div class="card-body">
                <form id="mainForm" method="post" novalidate>
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="row">
                      <div class="col-md-7">
                        {% for field in form %}
                        <div class="mb-3">
                            <label for="{{ field.id_for_label }}" class="form-label">
                                {{ field.label }}
                                {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                            </label>
                            {{ field }}
                            {% if field.help_text %}
                            <div class="form-text">{{ field.help_text }}</div>
                            {% endif %}
                            {% for error in field.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Save</button>
                            <a href="{% url 'tracker:dashboard' %}" class="btn btn-secondary">Cancel</a>
                        </div>
                      </div>

                      <div class="col-md-5">
                        {# Payments panel: show only if payment_form or payments exist in context #}
                        {% if payment_form or payments %}
                        <div class="payments-panel card p-3">
                            <h6 class="mb-2">Payments</h6>

                            <!-- Quick payments form (AJAX) -->
                            <form id="paymentForm" method="post" action="{% url 'tracker:add_payment' %}">
                                {% csrf_token %}
                                <input type="hidden" name="tender" id="payment_tender" value="{{ tender.id|default:'' }}">
                                <div class="mb-2">
                                    <label for="payment_amount" class="form-label small">Amount</label>
                                    <input type="number" step="0.01" min="0" class="form-control" id="payment_amount" name="amount" placeholder="0.00" required>
                                </div>
                                <div class="mb-2">
                                    <label for="payment_note" class="form-label small">Note (optional)</label>
                                    <input type="text" class="form-control" id="payment_note" name="note" placeholder="e.g. deposit, tranche 1">
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-sm btn-success" id="paymentSubmit">Record Payment</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="paymentClear">Clear</button>
                                </div>
                                <div id="paymentMessage" class="mt-2" style="display:none;"></div>
                            </form>

                            <hr>

                            <div class="payments-list" id="paymentsList">
                                {% if payments %}
                                    {% for p in payments %}
                                    <div class="payment-item d-flex justify-content-between align-items-start">
                                        <div>
                                            <div><strong>{{ p.amount|floatformat:2 }}</strong> <span class="small-muted">K</span></div>
                                            <div class="small-muted">{{ p.date }} {% if p.note %}• {{ p.note }}{% endif %}</div>
                                        </div>
                                        <div>
                                            <a href="{% url 'tracker:payment_delete' p.id %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete payment?')">Delete</a>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="small-muted">No payments recorded.</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                      </div>
                    </div>
                </form>
            </div>
        </div>

        {# show any form-level messages #}
        {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    </div>

    <script>
        // Add Bootstrap form styling
        document.addEventListener('DOMContentLoaded', function() {
            // add classes to inputs rendered by Django forms
            const inputs = document.querySelectorAll('#mainForm input, #mainForm select, #mainForm textarea');
            inputs.forEach(input => {
                if (input.type !== 'checkbox' && input.type !== 'radio' && !input.classList.contains('form-control')) {
                    input.classList.add('form-control');
                }
            });

            // payment form handling (AJAX)
            const paymentForm = document.getElementById('paymentForm');
            if (paymentForm) {
                paymentForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const submitBtn = document.getElementById('paymentSubmit');
                    const amountEl = document.getElementById('payment_amount');
                    const noteEl = document.getElementById('payment_note');
                    const tenderId = document.getElementById('payment_tender').value;
                    const messageEl = document.getElementById('paymentMessage');

                    // basic validation
                    const amount = parseFloat(amountEl.value);
                    if (!tenderId) {
                        showPaymentMessage('Tender ID not available. Save the tender first.', 'danger');
                        return;
                    }
                    if (!amount || isNaN(amount) || amount <= 0) {
                        showPaymentMessage('Enter a valid amount greater than 0', 'danger');
                        return;
                    }

                    submitBtn.disabled = true;
                    showPaymentMessage('Recording payment...', 'info');

                    try {
                        const formData = new FormData();
                        formData.append('tender', tenderId);
                        formData.append('amount', amountEl.value);
                        if (noteEl.value) formData.append('note', noteEl.value);

                        // include CSRF token
                        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                        const resp = await fetch(paymentForm.action, {
                            method: 'POST',
                            headers: { 'X-CSRFToken': csrftoken },
                            body: formData
                        });

                        if (!resp.ok) {
                            const text = await resp.text();
                            throw new Error(text || 'Request failed');
                        }

                        const result = await resp.json();

                        // success: append the new payment to the list (simple optimistic update)
                        appendPaymentToList(amountEl.value, noteEl.value);
                        amountEl.value = '';
                        noteEl.value = '';
                        showPaymentMessage(result.message || 'Payment recorded', 'success');
                    } catch (err) {
                        console.error(err);
                        showPaymentMessage('Failed to record payment', 'danger');
                    } finally {
                        submitBtn.disabled = false;
                    }
                });

                document.getElementById('paymentClear').addEventListener('click', function() {
                    document.getElementById('payment_amount').value = '';
                    document.getElementById('payment_note').value = '';
                    document.getElementById('paymentMessage').style.display = 'none';
                });

                function showPaymentMessage(text, type) {
                    const el = document.getElementById('paymentMessage');
                    el.style.display = 'block';
                    el.className = '';
                    el.classList.add('mt-2');
                    el.classList.add('alert');
                    if (type === 'success') el.classList.add('alert-success'); 
                    else if (type === 'danger') el.classList.add('alert-danger');
                    else el.classList.add('alert-info');
                    el.textContent = text;
                }

                function appendPaymentToList(amount, note) {
                    const list = document.getElementById('paymentsList');
                    const d = document.createElement('div');
                    d.className = 'payment-item d-flex justify-content-between align-items-start';
                    const left = document.createElement('div');
                    left.innerHTML = `<div><strong>${parseFloat(amount).toFixed(2)}</strong> <span class="small-muted">K</span></div><div class="small-muted">${new Date().toISOString().slice(0,10)} ${note ? '• ' + note : ''}</div>`;
                    const right = document.createElement('div');
                    right.innerHTML = '<button class="btn btn-sm btn-outline-secondary" disabled>Recorded</button>';
                    d.appendChild(left);
                    d.appendChild(right);
                    // add to top
                    if (list.firstChild) list.insertBefore(d, list.firstChild);
                    else list.appendChild(d);
                }
            }

        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
